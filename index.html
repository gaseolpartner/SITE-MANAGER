<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í˜„ì¥ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root{--primary:#0f172a;--accent:#3b82f6;--accent-hover:#2563eb;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--purple:#8b5cf6;--bg:#f8fafc;--card:#fff;--border:#e2e8f0;--text:#334155;--text-light:#64748b;--shadow:0 1px 3px rgba(0,0,0,.1);--shadow-md:0 4px 6px -1px rgba(0,0,0,.1);--radius:12px;--radius-sm:8px}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);line-height:1.6;min-height:100vh}
        .login-page{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#0f172a 0%,#1e3a5f 50%,#0f172a 100%)}
        .login-card{background:var(--card);padding:48px 40px;border-radius:20px;box-shadow:var(--shadow-md);width:420px;max-width:90%}
        .login-logo{text-align:center;margin-bottom:32px}
        .login-logo h1{font-size:26px;font-weight:700;color:var(--primary);margin-bottom:8px}
        .login-logo p{color:var(--text-light);font-size:14px}
        .form-group{margin-bottom:20px}
        .form-label{display:block;font-size:14px;font-weight:500;color:var(--text);margin-bottom:8px}
        .form-input,.form-select,.form-textarea{width:100%;padding:14px 16px;border:2px solid var(--border);border-radius:var(--radius-sm);font-size:15px;font-family:inherit;background:var(--bg)}
        .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--accent);background:var(--card)}
        .form-textarea{min-height:120px;resize:vertical}
        .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 24px;border:none;border-radius:var(--radius-sm);font-size:15px;font-weight:600;font-family:inherit;cursor:pointer;transition:all .2s}
        .btn-primary{background:var(--accent);color:#fff;width:100%}
        .btn-primary:hover{background:var(--accent-hover)}
        .btn-secondary{background:var(--bg);color:var(--text);border:2px solid var(--border)}
        .btn-secondary:hover{background:var(--border)}
        .btn-success{background:var(--success);color:#fff}
        .btn-danger{background:var(--danger);color:#fff}
        .btn-sm{padding:8px 16px;font-size:13px}
        .btn-xs{padding:6px 12px;font-size:12px}
        .toggle-link{text-align:center;margin-top:24px;font-size:14px;color:var(--text-light)}
        .toggle-link a{color:var(--accent);text-decoration:none;font-weight:600;margin-left:4px}
        .alert{padding:12px 16px;border-radius:var(--radius-sm);font-size:14px;margin-bottom:20px;display:none}
        .alert-error{background:#fef2f2;color:var(--danger);border:1px solid #fecaca}
        .alert-success{background:#f0fdf4;color:var(--success);border:1px solid #bbf7d0}
        .main-system{display:none;min-height:100vh}
        .header{background:var(--primary);color:#fff;padding:0 32px;height:64px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
        .header-left{display:flex;align-items:center;gap:12px}
        .header-left h1{font-size:18px;font-weight:600}
        .header-right{display:flex;align-items:center;gap:16px}
        .user-badge{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.1);padding:6px 14px;border-radius:20px;font-size:14px}
        .user-avatar{width:28px;height:28px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600}
        .header-btn{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2);padding:8px 16px;border-radius:var(--radius-sm);font-size:13px;font-family:inherit;cursor:pointer}
        .header-btn:hover{background:rgba(255,255,255,.2)}
        .sync-indicator{font-size:12px;opacity:.8}
        .sync-indicator.syncing{color:var(--warning)}
        .sync-indicator.synced{color:var(--success)}
        .content{padding:24px 32px;max-width:1440px;margin:0 auto}
        .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:28px}
        .stat-card{background:var(--card);border-radius:var(--radius);padding:24px;box-shadow:var(--shadow);display:flex;align-items:center;gap:16px;cursor:pointer;border:1px solid var(--border)}
        .stat-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-md);border-color:var(--accent)}
        .stat-icon{width:52px;height:52px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:24px}
        .stat-icon.blue{background:linear-gradient(135deg,#3b82f6,#1d4ed8)}
        .stat-icon.green{background:linear-gradient(135deg,#10b981,#059669)}
        .stat-icon.yellow{background:linear-gradient(135deg,#f59e0b,#d97706)}
        .stat-icon.purple{background:linear-gradient(135deg,#8b5cf6,#6d28d9)}
        .stat-info h3{font-size:28px;font-weight:700;color:var(--primary);line-height:1}
        .stat-info p{font-size:13px;color:var(--text-light);margin-top:4px}
        .tabs-wrapper{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;border:1px solid var(--border)}
        .tabs-nav{display:flex;background:var(--bg);border-bottom:1px solid var(--border);overflow-x:auto}
        .tab-btn{padding:16px 28px;font-size:14px;font-weight:500;color:var(--text-light);background:none;border:none;cursor:pointer;font-family:inherit;white-space:nowrap;position:relative}
        .tab-btn:hover{color:var(--accent);background:rgba(59,130,246,.05)}
        .tab-btn.active{color:var(--accent);background:var(--card)}
        .tab-btn.active::after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:2px;background:var(--accent)}
        .tab-panel{display:none;padding:24px}
        .tab-panel.active{display:block}
        .controls-bar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:20px;padding:16px;background:var(--bg);border-radius:var(--radius-sm)}
        .search-box{display:flex;align-items:center;background:var(--card);border:2px solid var(--border);border-radius:var(--radius-sm);padding:0 12px;flex:1;max-width:360px}
        .search-box:focus-within{border-color:var(--accent)}
        .search-box input{flex:1;border:none;padding:12px;font-size:14px;font-family:inherit;background:transparent}
        .search-box input:focus{outline:none}
        .search-box span{color:var(--text-light)}
        .filter-pills{display:flex;gap:8px}
        .filter-pill{padding:10px 18px;border:2px solid var(--border);background:var(--card);border-radius:20px;font-size:13px;font-weight:500;font-family:inherit;cursor:pointer;color:var(--text)}
        .filter-pill:hover{border-color:var(--accent);color:var(--accent)}
        .filter-pill.active{background:var(--accent);border-color:var(--accent);color:#fff}
        .table-container{overflow-x:auto}
        table{width:100%;border-collapse:collapse}
        th,td{padding:14px 16px;text-align:left;font-size:14px}
        th{background:var(--primary);color:#fff;font-weight:500;white-space:nowrap}
        th:first-child{border-radius:var(--radius-sm) 0 0 0}
        th:last-child{border-radius:0 var(--radius-sm) 0 0}
        tr{border-bottom:1px solid var(--border)}
        tr:hover{background:var(--bg)}
        .company-name{font-weight:600;color:var(--primary)}
        .amount{font-family:'SF Mono',Consolas,monospace;color:var(--accent);font-weight:500}
        .badge{display:inline-flex;align-items:center;padding:6px 12px;border-radius:16px;font-size:12px;font-weight:600}
        .badge-active{background:rgba(16,185,129,.1);color:var(--success)}
        .badge-pending{background:rgba(245,158,11,.1);color:var(--warning)}
        .badge-completed{background:rgba(139,92,246,.1);color:var(--purple)}
        .badge-trading{background:rgba(59,130,246,.1);color:var(--accent)}
        .progress-bar{width:100%;height:8px;background:var(--border);border-radius:4px;overflow:hidden}
        .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--success));border-radius:4px}
        .progress-text{font-size:12px;color:var(--text-light);margin-top:4px;text-align:center}
        .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center;padding:20px}
        .modal{background:var(--card);border-radius:var(--radius);width:100%;max-width:560px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column}
        .modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
        .modal-header h2{font-size:18px;font-weight:600}
        .modal-close{background:none;border:none;font-size:24px;color:var(--text-light);cursor:pointer;padding:4px;line-height:1}
        .modal-body{padding:24px;overflow-y:auto;flex:1}
        .modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:12px;justify-content:flex-end}
        .empty-state{text-align:center;padding:60px 20px;color:var(--text-light)}
        .empty-state .icon{font-size:48px;margin-bottom:16px}
        .empty-state h3{font-size:18px;font-weight:600;color:var(--text);margin-bottom:8px}
        .loading{text-align:center;padding:40px}
        .spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .site-item{padding:16px;border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;background:var(--bg)}
        .site-info h4{font-size:15px;font-weight:600;color:var(--primary);margin-bottom:4px}
        .site-info p{font-size:13px;color:var(--text-light)}
        .site-actions{display:flex;gap:8px}
        .site-list{max-height:400px;overflow-y:auto}
        .briefing-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px}
        .briefing-date{display:flex;align-items:center;gap:12px}
        .briefing-date h2{font-size:20px;font-weight:700;color:var(--primary)}
        .briefing-date select{padding:8px 12px;border:2px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:14px;background:var(--card)}
        .no-briefing{text-align:center;padding:60px 20px;background:var(--bg);border-radius:var(--radius)}
        .no-briefing .icon{font-size:64px;margin-bottom:16px}
        .no-briefing h3{font-size:18px;font-weight:600;color:var(--text);margin-bottom:8px}
        .no-briefing p{color:var(--text-light);margin-bottom:20px}
        .analysis-card{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;margin-bottom:12px}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        @media(max-width:768px){.header{padding:0 16px}.content{padding:16px}.dashboard-grid{grid-template-columns:repeat(2,1fr)}.controls-bar{flex-direction:column;align-items:stretch}.search-box{max-width:none}.form-row{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <div class="login-page" id="loginPage">
        <div class="login-card">
            <div class="login-logo"><h1>ğŸ—ï¸ í˜„ì¥ê´€ë¦¬ ì‹œìŠ¤í…œ</h1><p id="formTitle">ì‹œìŠ¤í…œì— ë¡œê·¸ì¸í•˜ì„¸ìš”</p></div>
            <div class="alert alert-error" id="errorAlert"></div>
            <div class="alert alert-success" id="successAlert"></div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group"><label class="form-label">ì•„ì´ë””</label><input type="text" class="form-input" id="loginId" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required></div>
                <div class="form-group"><label class="form-label">ë¹„ë°€ë²ˆí˜¸</label><input type="password" class="form-input" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required></div>
                <button type="submit" class="btn btn-primary">ë¡œê·¸ì¸</button>
            </form>
            <form id="registerForm" style="display:none" onsubmit="handleRegister(event)">
                <div class="form-group"><label class="form-label">ì´ë¦„</label><input type="text" class="form-input" id="regName" placeholder="ì´ë¦„" required></div>
                <div class="form-group"><label class="form-label">ì•„ì´ë””</label><input type="text" class="form-input" id="regId" placeholder="ì•„ì´ë””" required></div>
                <div class="form-group"><label class="form-label">ë¹„ë°€ë²ˆí˜¸</label><input type="password" class="form-input" id="regPw" placeholder="ë¹„ë°€ë²ˆí˜¸" required></div>
                <div class="form-group"><label class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input type="password" class="form-input" id="regPwConfirm" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" required></div>
                <div class="form-group"><label class="form-label">ë¶€ì„œ</label><input type="text" class="form-input" id="regDept" placeholder="ë¶€ì„œ (ì„ íƒ)"></div>
                <button type="submit" class="btn btn-primary">íšŒì›ê°€ì…</button>
            </form>
            <div class="toggle-link"><span id="toggleText">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?</span><a href="#" id="toggleLink" onclick="toggleAuthForm()">íšŒì›ê°€ì…</a></div>
        </div>
    </div>
    <div class="main-system" id="mainSystem">
        <header class="header">
            <div class="header-left"><h1>ğŸ—ï¸ í˜„ì¥ê´€ë¦¬ ì‹œìŠ¤í…œ</h1><span class="sync-indicator" id="syncIndicator">â— ì—°ê²°ë¨</span></div>
            <div class="header-right">
                <div class="user-badge"><div class="user-avatar" id="userAvatar">ê´€</div><span id="userName">ê´€ë¦¬ì</span></div>
                <div id="adminBtns" style="display:none"><button class="header-btn" onclick="openUserModal()">ğŸ‘¥ íšŒì›ê´€ë¦¬</button></div>
                <button class="header-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </header>
        <div class="content">
            <div class="dashboard-grid">
                <div class="stat-card" onclick="filterByStatus('all')"><div class="stat-icon blue">ğŸ“Š</div><div class="stat-info"><h3 id="totalCount">0</h3><p>ì „ì²´ í˜„ì¥</p></div></div>
                <div class="stat-card" onclick="filterByStatus('active')"><div class="stat-icon green">ğŸš§</div><div class="stat-info"><h3 id="activeCount">0</h3><p>ì§„í–‰ì¤‘</p></div></div>
                <div class="stat-card" onclick="filterByStatus('pending')"><div class="stat-icon yellow">â³</div><div class="stat-info"><h3 id="pendingCount">0</h3><p>ëŒ€ê¸°ì¤‘</p></div></div>
                <div class="stat-card" onclick="filterByStatus('completed')"><div class="stat-icon purple">âœ…</div><div class="stat-info"><h3 id="completedCount">0</h3><p>ì™„ë£Œ</p></div></div>
            </div>
            <div class="tabs-wrapper">
                <div class="tabs-nav">
                    <button class="tab-btn active" onclick="switchTab('briefing',this)">ğŸ“‹ ì¼ì¼ ë¸Œë¦¬í•‘</button>
                    <button class="tab-btn" onclick="switchTab('sales',this)">ğŸ“ˆ ì˜ì—… ê³„íš</button>
                    <button class="tab-btn" onclick="switchTab('all',this)">ğŸ—ï¸ ì „ì²´ í˜„ì¥</button>
                    <button class="tab-btn" onclick="switchTab('concrete',this)">ğŸ¢ ì² ê·¼ì½˜í¬ë¦¬íŠ¸ <span id="concreteCount" style="opacity:.7">(0)</span></button>
                    <button class="tab-btn" onclick="switchTab('stone',this)">ğŸª¨ ì„ê³µì‚¬ <span id="stoneCount" style="opacity:.7">(0)</span></button>
                </div>
                <div class="tab-panel" id="panel-briefing">
                    <div class="briefing-header">
                        <div class="briefing-date"><h2>ğŸ“… <span id="briefingDateDisplay">ì˜¤ëŠ˜</span></h2><select id="briefingDateSelect" onchange="loadBriefing(this.value)"></select></div>
                        <div><button class="btn btn-primary btn-sm" onclick="openPasteModal()">ğŸ“‹ ë¶™ì—¬ë„£ê¸°ë¡œ ì¶”ê°€</button></div>
                    </div>
                    <div id="briefingContent"></div>
                </div>
                <div class="tab-panel" id="panel-sales">
                    <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px">
                        <h3 style="margin:0;font-size:18px">ğŸ“ˆ ì˜ì—… ê³„íš</h3>
                        <select class="form-select" id="salesYearFilter" onchange="renderSalesTable()" style="width:auto;padding:8px 16px;font-weight:600">
                            <option value="all">ì „ì²´ ë…„ë„</option>
                            <option value="24">2024ë…„</option>
                            <option value="25">2025ë…„</option>
                            <option value="26" selected>2026ë…„</option>
                            <option value="27">2027ë…„</option>
                        </select>
                        <select class="form-select" id="salesCategoryFilter" onchange="renderSalesTable()" style="width:auto;padding:8px 16px;font-weight:600">
                            <option value="all">ì „ì²´</option>
                            <option value="ê±´ì¶•">ğŸ—ï¸ ê±´ì¶•</option>
                            <option value="ì„ì¬">ğŸª¨ ì„ì¬</option>
                        </select>
                    </div>
                    <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); margin-bottom: 16px;">
                        <div class="stat-card" style="padding:16px;cursor:pointer" onclick="setSalesMonthFilter('all')"><div class="stat-info" style="text-align:center;width:100%"><h3 id="salesTotalCount" style="font-size:22px">0</h3><p>ì „ì²´</p></div></div>
                        <div class="stat-card" style="padding:16px;cursor:pointer" onclick="setSalesMonthFilter('1')"><div class="stat-info" style="text-align:center;width:100%"><h3 id="salesMonth1" style="font-size:22px">0</h3><p>1ì›”</p></div></div>
                        <div class="stat-card" style="padding:16px;cursor:pointer" onclick="setSalesMonthFilter('2')"><div class="stat-info" style="text-align:center;width:100%"><h3 id="salesMonth2" style="font-size:22px">0</h3><p>2ì›”</p></div></div>
                        <div class="stat-card" style="padding:16px;cursor:pointer" onclick="setSalesMonthFilter('3')"><div class="stat-info" style="text-align:center;width:100%"><h3 id="salesMonth3" style="font-size:22px">0</h3><p>3ì›”</p></div></div>
                        <div class="stat-card" style="padding:16px;cursor:pointer" onclick="setSalesMonthFilter('4')"><div class="stat-info" style="text-align:center;width:100%"><h3 id="salesMonth4" style="font-size:22px">0</h3><p>4ì›”</p></div></div>
                        <div class="stat-card" style="padding:16px;cursor:pointer" onclick="setSalesMonthFilter('5')"><div class="stat-info" style="text-align:center;width:100%"><h3 id="salesMonth5" style="font-size:22px">0</h3><p>5ì›”</p></div></div>
                        <div class="stat-card" style="padding:16px;cursor:pointer" onclick="setSalesMonthFilter('6')"><div class="stat-info" style="text-align:center;width:100%"><h3 id="salesMonth6" style="font-size:22px">0</h3><p>6ì›”</p></div></div>
                        <div class="stat-card" style="padding:16px;cursor:pointer" onclick="setSalesMonthFilter('7')"><div class="stat-info" style="text-align:center;width:100%"><h3 id="salesMonth7" style="font-size:22px">0</h3><p>7ì›”</p></div></div>
                        <div class="stat-card" style="padding:16px;cursor:pointer" onclick="setSalesMonthFilter('8')"><div class="stat-info" style="text-align:center;width:100%"><h3 id="salesMonth8" style="font-size:22px">0</h3><p>8ì›”</p></div></div>
                        <div class="stat-card" style="padding:16px;cursor:pointer" onclick="setSalesMonthFilter('9')"><div class="stat-info" style="text-align:center;width:100%"><h3 id="salesMonth9" style="font-size:22px">0</h3><p>9ì›”</p></div></div>
                        <div class="stat-card" style="padding:16px;cursor:pointer" onclick="setSalesMonthFilter('10')"><div class="stat-info" style="text-align:center;width:100%"><h3 id="salesMonth10" style="font-size:22px">0</h3><p>10ì›”</p></div></div>
                        <div class="stat-card" style="padding:16px;cursor:pointer" onclick="setSalesMonthFilter('11')"><div class="stat-info" style="text-align:center;width:100%"><h3 id="salesMonth11" style="font-size:22px">0</h3><p>11ì›”</p></div></div>
                        <div class="stat-card" style="padding:16px;cursor:pointer" onclick="setSalesMonthFilter('12')"><div class="stat-info" style="text-align:center;width:100%"><h3 id="salesMonth12" style="font-size:22px">0</h3><p>12ì›”</p></div></div>
                    </div>
                    <div class="controls-bar">
                        <div class="search-box"><span>ğŸ”</span><input type="text" id="searchSales" placeholder="í˜„ì¥ëª…, ê±´ì„¤ì‚¬, ì§€ì—­ ê²€ìƒ‰..." oninput="renderSalesTable()"></div>
                        <div class="filter-pills">
                            <button class="filter-pill active" onclick="setSalesFilter(this,'all')">ì „ì²´</button>
                            <button class="filter-pill" onclick="setSalesFilter(this,'mine')">ë‚´ ë‹´ë‹¹</button>
                            <button class="filter-pill" onclick="setSalesFilter(this,'unassigned')">ë¯¸ë°°ì •</button>
                        </div>
                        <button class="btn btn-success btn-sm" id="addSalesPlanBtn" onclick="openSalesPlanModal()">â• ì¶”ê°€</button>
                        <button class="btn btn-primary btn-sm" onclick="openExcelUploadModal()">ğŸ“ ì—‘ì…€ ì—…ë¡œë“œ</button>
                    </div>
                    <div class="table-container" id="salesTableContainer"><div class="loading"><div class="spinner"></div><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div></div>
                </div>
                <div class="tab-panel" id="panel-all">
                    <div class="controls-bar">
                        <div class="search-box"><span>ğŸ”</span><input type="text" id="searchAll" placeholder="í˜„ì¥ëª…, ì—…ì²´ëª… ê²€ìƒ‰..." oninput="searchSites()"></div>
                        <div class="filter-pills">
                            <button class="filter-pill active" onclick="setFilter(this,'all')">ì „ì²´</button>
                            <button class="filter-pill" onclick="setFilter(this,'active')">ì§„í–‰ì¤‘</button>
                            <button class="filter-pill" onclick="setFilter(this,'pending')">ëŒ€ê¸°ì¤‘</button>
                            <button class="filter-pill" onclick="setFilter(this,'completed')">ì™„ë£Œ</button>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="openQuickAddModal()">â• í˜„ì¥ ì¶”ê°€</button>
                    </div>
                    <div class="table-container">
                        <table><thead><tr><th>No</th><th>í˜„ì¥ëª…</th><th>ì—…ì²´ëª…</th><th>êµ¬ë¶„</th><th>ë‹´ë‹¹ì</th><th>ì—°ë½ì²˜</th><th>ê³„ì•½ê¸ˆì•¡</th><th style="width:140px">ì§„í–‰ë¥ </th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead><tbody id="allSitesTable"></tbody></table>
                    </div>
                </div>
                <div class="tab-panel" id="panel-concrete">
                    <div class="controls-bar">
                        <div class="search-box"><span>ğŸ”</span><input type="text" id="searchConcrete" placeholder="ì—…ì²´ëª…, ëŒ€í‘œì ê²€ìƒ‰..." oninput="renderConcreteTable()"></div>
                        <div class="filter-pills">
                            <button class="filter-pill active" onclick="setConcreteFilter(this,'all')">ì „ì²´</button>
                            <button class="filter-pill" onclick="setConcreteFilter(this,'trading')">ê±°ë˜ì¤‘</button>
                        </div>
                        <button class="btn btn-success btn-sm" id="addConcreteBtn" style="display:none" onclick="openAddCompanyModal('concrete')">â• ì—…ì²´ ì¶”ê°€</button>
                    </div>
                    <div class="table-container" id="concreteTableContainer"><div class="loading"><div class="spinner"></div><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div></div>
                </div>
                <div class="tab-panel" id="panel-stone">
                    <div class="controls-bar">
                        <div class="search-box"><span>ğŸ”</span><input type="text" id="searchStone" placeholder="ì—…ì²´ëª…, ëŒ€í‘œì ê²€ìƒ‰..." oninput="renderStoneTable()"></div>
                        <div class="filter-pills">
                            <button class="filter-pill active" onclick="setStoneFilter(this,'all')">ì „ì²´</button>
                            <button class="filter-pill" onclick="setStoneFilter(this,'trading')">ê±°ë˜ì¤‘</button>
                        </div>
                        <button class="btn btn-success btn-sm" id="addStoneBtn" style="display:none" onclick="openAddCompanyModal('stone')">â• ì—…ì²´ ì¶”ê°€</button>
                    </div>
                    <div class="table-container" id="stoneTableContainer"><div class="loading"><div class="spinner"></div><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬ë“¤ -->
    <div class="modal-overlay" id="userModal"><div class="modal"><div class="modal-header"><h2>ğŸ‘¥ íšŒì› ê´€ë¦¬</h2><button class="modal-close" onclick="closeModal('userModal')">&times;</button></div><div class="modal-body"><div class="site-list" id="userList"></div></div></div></div>
    <div class="modal-overlay" id="companyModal"><div class="modal"><div class="modal-header"><h2 id="companyModalTitle">ì—…ì²´ í˜„ì¥ ê´€ë¦¬</h2><button class="modal-close" onclick="closeModal('companyModal')">&times;</button></div><div class="modal-body"><button class="btn btn-success" style="width:100%;margin-bottom:16px" onclick="addSiteToCompany()">â• ìƒˆ í˜„ì¥ ì¶”ê°€</button><div class="site-list" id="companySiteList"></div></div></div></div>
    <div class="modal-overlay" id="siteModal"><div class="modal"><div class="modal-header"><h2 id="siteModalTitle">í˜„ì¥ ì •ë³´</h2><button class="modal-close" onclick="closeModal('siteModal')">&times;</button></div><div class="modal-body">
        <div class="form-group"><label class="form-label">í˜„ì¥ëª… *</label><input type="text" class="form-input" id="siteName" placeholder="í˜„ì¥ëª…"></div>
        <div class="form-group"><label class="form-label">í˜„ì¥ ì£¼ì†Œ</label><input type="text" class="form-input" id="siteAddr" placeholder="ì£¼ì†Œ"></div>
        <div class="form-group"><label class="form-label">ë‹´ë‹¹ì</label><input type="text" class="form-input" id="siteManager" placeholder="ë‹´ë‹¹ìëª…"></div>
        <div class="form-group"><label class="form-label">ì—°ë½ì²˜</label><input type="text" class="form-input" id="sitePhone" placeholder="ì—°ë½ì²˜"></div>
        <div class="form-group"><label class="form-label">ê³„ì•½ê¸ˆì•¡</label><input type="text" class="form-input" id="siteAmount" placeholder="ì˜ˆ: 5ì–µì›"></div>
        <div class="form-group"><label class="form-label">ì§„í–‰ë¥  (%)</label><input type="number" class="form-input" id="siteProgress" min="0" max="100" value="0"></div>
        <div class="form-group"><label class="form-label">ìƒíƒœ</label><select class="form-select" id="siteStatus"><option value="active">ì§„í–‰ì¤‘</option><option value="pending">ëŒ€ê¸°ì¤‘</option><option value="completed">ì™„ë£Œ</option></select></div>
    </div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('siteModal')">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="saveSite()">ì €ì¥</button></div></div></div>
    <div class="modal-overlay" id="quickAddModal"><div class="modal"><div class="modal-header"><h2>â• ë¹ ë¥¸ í˜„ì¥ ì¶”ê°€</h2><button class="modal-close" onclick="closeModal('quickAddModal')">&times;</button></div><div class="modal-body">
        <div class="form-group"><label class="form-label">ê³µì‚¬ êµ¬ë¶„ *</label><select class="form-select" id="quickType" onchange="updateQuickCompanyList()"><option value="">ì„ íƒí•˜ì„¸ìš”</option><option value="concrete">ì² ê·¼ì½˜í¬ë¦¬íŠ¸</option><option value="stone">ì„ê³µì‚¬</option></select></div>
        <div class="form-group"><label class="form-label">ì—…ì²´ *</label><select class="form-select" id="quickCompany"><option value="">ë¨¼ì € ê³µì‚¬ êµ¬ë¶„ì„ ì„ íƒí•˜ì„¸ìš”</option></select></div>
        <div class="form-group"><label class="form-label">í˜„ì¥ëª… *</label><input type="text" class="form-input" id="quickSiteName" placeholder="í˜„ì¥ëª…"></div>
        <div class="form-group"><label class="form-label">í˜„ì¥ ì£¼ì†Œ</label><input type="text" class="form-input" id="quickAddr" placeholder="ì£¼ì†Œ"></div>
        <div class="form-group"><label class="form-label">ë‹´ë‹¹ì</label><input type="text" class="form-input" id="quickManager" placeholder="ë‹´ë‹¹ìëª…"></div>
        <div class="form-group"><label class="form-label">ì—°ë½ì²˜</label><input type="text" class="form-input" id="quickPhone" placeholder="ì—°ë½ì²˜"></div>
        <div class="form-group"><label class="form-label">ìƒíƒœ</label><select class="form-select" id="quickStatus"><option value="active">ì§„í–‰ì¤‘</option><option value="pending">ëŒ€ê¸°ì¤‘</option></select></div>
    </div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('quickAddModal')">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="saveQuickSite()">ì €ì¥</button></div></div></div>
    <div class="modal-overlay" id="pasteModal"><div class="modal" style="max-width:700px"><div class="modal-header"><h2>ğŸ“‹ ë¸Œë¦¬í•‘ ë¶™ì—¬ë„£ê¸°</h2><button class="modal-close" onclick="closeModal('pasteModal')">&times;</button></div><div class="modal-body">
        <p style="margin-bottom:16px;color:var(--text-light);font-size:14px">Geminiì—ì„œ ë°›ì€ ë¸Œë¦¬í•‘ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
        <div class="form-group"><label class="form-label">ë¸Œë¦¬í•‘ ë‚ ì§œ</label><input type="date" class="form-input" id="pasteDate"></div>
        <div class="form-group"><label class="form-label">ë¸Œë¦¬í•‘ ë‚´ìš©</label><textarea class="form-textarea" id="pasteContent" rows="15" placeholder="ì—¬ê¸°ì— ë¸Œë¦¬í•‘ ë‚´ìš©ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea></div>
    </div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('pasteModal')">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="savePastedBriefing()">ì €ì¥</button></div></div></div>
    <div class="modal-overlay" id="salesPlanModal"><div class="modal"><div class="modal-header"><h2 id="salesPlanModalTitle">ì˜ì—… ê³„íš ì¶”ê°€</h2><button class="modal-close" onclick="closeModal('salesPlanModal')">&times;</button></div><div class="modal-body">
        <input type="hidden" id="salesPlanId">
        <div class="form-row">
            <div class="form-group"><label class="form-label">ëŒ€ë¶„ë¥˜ *</label><select class="form-select" id="salesCategory"><option value="ê±´ì¶•">ğŸ—ï¸ ê±´ì¶•</option><option value="ì„ì¬">ğŸª¨ ì„ì¬</option></select></div>
            <div class="form-group"><label class="form-label">ì§€ì—­</label><input type="text" class="form-input" id="salesRegion" placeholder="ì˜ˆ: ì„œìš¸, ê²½ê¸°"></div>
        </div>
        <div class="form-group"><label class="form-label">í˜„ì¥ëª… *</label><input type="text" class="form-input" id="salesSiteName" placeholder="í˜„ì¥ëª…"></div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">êµ¬ë¶„</label><input type="text" class="form-input" id="salesSection" placeholder="ì˜ˆ: ì¬ê°œë°œ, ì‹ ì¶•"></div>
            <div class="form-group"><label class="form-label">ê³¨ì¡°ì‚¬</label><input type="text" class="form-input" id="salesConcrete" placeholder="ê³¨ì¡° ì—…ì²´ëª…"></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">ê±´ì„¤ì‚¬</label><input type="text" class="form-input" id="salesConstruction" placeholder="ê±´ì„¤ì‚¬ëª…"></div>
            <div class="form-group"><label class="form-label">ê·œëª¨</label><input type="text" class="form-input" id="salesScale" placeholder="ì˜ˆ: B2/25F"></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label class="form-label">ì°©ê³µì¼</label><input type="text" class="form-input" id="salesStartDate" placeholder="ì˜ˆ: 25ë…„ 12ì›”"></div>
            <div class="form-group"></div>
        </div>
        <div class="form-group"><label class="form-label">ë¹„ê³ </label><textarea class="form-textarea" id="salesMemo" rows="2" placeholder="ë¹„ê³ "></textarea></div>
    </div><div class="modal-footer"><button class="btn btn-danger" id="salesDeleteBtn" style="margin-right:auto;display:none" onclick="deleteSalesPlan()">ì‚­ì œ</button><button class="btn btn-secondary" onclick="closeModal('salesPlanModal')">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="saveSalesPlan()">ì €ì¥</button></div></div></div>
    <div class="modal-overlay" id="excelUploadModal"><div class="modal" style="max-width:900px"><div class="modal-header"><h2>ğŸ“ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h2><button class="modal-close" onclick="closeModal('excelUploadModal')">&times;</button></div><div class="modal-body">
        <div class="form-group">
            <label class="form-label">ì—‘ì…€ íŒŒì¼ ì„ íƒ</label>
            <input type="file" class="form-input" id="excelFileInput" accept=".xlsx,.xls" onchange="handleExcelFile(this)">
        </div>
        <div class="form-group" id="sheetSelectGroup" style="display:none">
            <label class="form-label">ì‹œíŠ¸ ì„ íƒ</label>
            <select class="form-select" id="sheetSelect" onchange="parseSelectedSheet()"></select>
        </div>
        <div id="excelPreview" style="display:none">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <label class="form-label" style="margin:0">ë¯¸ë¦¬ë³´ê¸° (<span id="previewCount">0</span>ê°œ í˜„ì¥)</label>
                <span style="font-size:12px;color:var(--text-light)">* ì²« í–‰(í—¤ë”)ì€ ì œì™¸ë©ë‹ˆë‹¤</span>
            </div>
            <div class="table-container" style="max-height:350px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--radius-sm)">
                <table id="excelPreviewTable"><thead></thead><tbody></tbody></table>
            </div>
        </div>
    </div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('excelUploadModal')">ì·¨ì†Œ</button><button class="btn btn-primary" id="excelImportBtn" onclick="importExcelData()" disabled>ì¶”ê°€í•˜ê¸°</button></div></div></div>
    <div class="modal-overlay" id="companyEditModal"><div class="modal"><div class="modal-header"><h2 id="companyEditModalTitle">ì—…ì²´ ì¶”ê°€</h2><button class="modal-close" onclick="closeModal('companyEditModal')">&times;</button></div><div class="modal-body">
        <input type="hidden" id="companyEditId"><input type="hidden" id="companyEditType">
        <div class="form-row">
            <div class="form-group"><label class="form-label">ìˆœìœ„</label><input type="number" class="form-input" id="companyRank" placeholder="ìˆœìœ„"></div>
            <div class="form-group"><label class="form-label">ìƒíƒœ</label><select class="form-select" id="companyStatusEdit"><option value="-">-</option><option value="ê±°ë˜ì¤‘">ê±°ë˜ì¤‘</option><option value="ê²¬ì ì„œì œì¶œ">ê²¬ì ì„œì œì¶œ</option></select></div>
        </div>
        <div class="form-group"><label class="form-label">ì—…ì²´ëª… *</label><input type="text" class="form-input" id="companyNameEdit" placeholder="ì—…ì²´ëª…"></div>
        <div class="form-group"><label class="form-label">ëŒ€í‘œì</label><input type="text" class="form-input" id="companyCeo" placeholder="ëŒ€í‘œì"></div>
        <div class="form-group"><label class="form-label">ì†Œì¬ì§€</label><input type="text" class="form-input" id="companyLocation" placeholder="ì†Œì¬ì§€"></div>
        <div class="form-group"><label class="form-label">ì‹œê³µëŠ¥ë ¥í‰ê°€</label><input type="text" class="form-input" id="companyAmount" placeholder="ì˜ˆ: 500ì–µì›"></div>
    </div><div class="modal-footer"><button class="btn btn-danger" id="companyDeleteBtn" style="margin-right:auto;display:none" onclick="deleteCompany()">ì‚­ì œ</button><button class="btn btn-secondary" onclick="closeModal('companyEditModal')">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="saveCompany()">ì €ì¥</button></div></div></div>

    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://lvcrejycsglsnhnjbnfy.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_EdmtKf2YYH9EdxyL1qddrw_vktFpPnh';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null, users = [], sites = [], briefings = {};
        let concreteCompanies = [], stoneCompanies = [];
        let salesPlans = [], salesFilter = 'all', salesMonthFilter = 'all';
        let currentFilter = 'all', concreteFilter = 'all', stoneFilter = 'all';
        let editingCompanyType = '', editingCompanyName = '', editingSiteId = null;

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => { checkAutoLogin(); initBriefingDates(); });

        // Supabaseì—ì„œ ì—…ì²´ ë°ì´í„° ë¡œë“œ
        async function loadCompaniesFromDB() {
            setSyncStatus('syncing');
            try {
                const { data, error } = await db.from('companies').select('*').order('rank', { ascending: true });
                if (error) throw error;
                concreteCompanies = data.filter(c => c.company_type === 'concrete');
                stoneCompanies = data.filter(c => c.company_type === 'stone');
                document.getElementById('concreteCount').textContent = '(' + concreteCompanies.length + ')';
                document.getElementById('stoneCount').textContent = '(' + stoneCompanies.length + ')';
            } catch (e) { console.error('ì—…ì²´ ë¡œë“œ ì‹¤íŒ¨:', e); }
            setSyncStatus('synced');
        }

        function checkAutoLogin() {
            const saved = localStorage.getItem('sm_currentUser');
            if (saved) { currentUser = JSON.parse(saved); showMainSystem(); }
        }

        // ì¸ì¦
        function toggleAuthForm() {
            const login = document.getElementById('loginForm'), register = document.getElementById('registerForm');
            if (login.style.display !== 'none') {
                login.style.display = 'none'; register.style.display = 'block';
                document.getElementById('formTitle').textContent = 'ìƒˆ ê³„ì • ë§Œë“¤ê¸°';
                document.getElementById('toggleText').textContent = 'ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?';
                document.getElementById('toggleLink').textContent = 'ë¡œê·¸ì¸';
            } else {
                login.style.display = 'block'; register.style.display = 'none';
                document.getElementById('formTitle').textContent = 'ì‹œìŠ¤í…œì— ë¡œê·¸ì¸í•˜ì„¸ìš”';
                document.getElementById('toggleText').textContent = 'ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?';
                document.getElementById('toggleLink').textContent = 'íšŒì›ê°€ì…';
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const id = document.getElementById('loginId').value, pw = document.getElementById('loginPw').value;
            setSyncStatus('syncing');
            try {
                const { data } = await db.from('site_users').select('*').eq('user_id', id).eq('password', pw).single();
                if (data) { currentUser = data; localStorage.setItem('sm_currentUser', JSON.stringify(data)); showMainSystem(); }
                else { showAlert('error', 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); }
            } catch (e) { showAlert('error', 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
            setSyncStatus('synced');
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('regName').value, id = document.getElementById('regId').value;
            const pw = document.getElementById('regPw').value, pwConfirm = document.getElementById('regPwConfirm').value;
            const dept = document.getElementById('regDept').value;
            if (pw !== pwConfirm) { showAlert('error', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
            setSyncStatus('syncing');
            try {
                const { error } = await db.from('site_users').insert([{ user_id: id, password: pw, name: name, role: 'user', department: dept || 'ë¯¸ì§€ì •' }]);
                if (error) { showAlert('error', error.code === '23505' ? 'ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.' : 'íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ ë°œìƒ'); }
                else { showAlert('success', 'íšŒì›ê°€ì… ì™„ë£Œ!'); setTimeout(toggleAuthForm, 1500); }
            } catch (e) { showAlert('error', 'íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
            setSyncStatus('synced');
        }

        function logout() { if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { currentUser = null; localStorage.removeItem('sm_currentUser'); location.reload(); } }
        function showAlert(type, msg) { const el = document.getElementById(type === 'error' ? 'errorAlert' : 'successAlert'); el.textContent = msg; el.style.display = 'block'; setTimeout(() => el.style.display = 'none', 3000); }
        function setSyncStatus(status) { const el = document.getElementById('syncIndicator'); el.textContent = status === 'syncing' ? 'â— ë™ê¸°í™” ì¤‘...' : 'â— ì—°ê²°ë¨'; el.className = 'sync-indicator ' + status; }

        // ë©”ì¸ ì‹œìŠ¤í…œ
        async function showMainSystem() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainSystem').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
            if (currentUser.role === 'admin') {
                document.getElementById('adminBtns').style.display = 'block';
                document.getElementById('addConcreteBtn').style.display = 'block';
                document.getElementById('addStoneBtn').style.display = 'block';
            }
            await loadCompaniesFromDB();
            await loadAllData();
            renderAll();
            await loadBriefingFromDB();
        }

        async function loadAllData() {
            setSyncStatus('syncing');
            try {
                const { data: sitesData } = await db.from('sites').select('*').order('created_at', { ascending: false });
                if (sitesData) sites = sitesData;
                const { data: salesData } = await db.from('sales_plan').select('*').order('created_at', { ascending: false });
                if (salesData) salesPlans = salesData;
                if (currentUser.role === 'admin') {
                    const { data: usersData } = await db.from('site_users').select('*');
                    if (usersData) users = usersData;
                }
            } catch (e) { console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', e); }
            setSyncStatus('synced');
        }

        function renderAll() { renderAllSites(); renderConcreteTable(); renderStoneTable(); renderSalesTable(); updateCounts(); }
        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('panel-' + tabId).classList.add('active');
        }

        // ë¸Œë¦¬í•‘
        function initBriefingDates() {
            const select = document.getElementById('briefingDateSelect'), today = new Date();
            for (let i = 0; i < 7; i++) {
                const date = new Date(today); date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const option = document.createElement('option');
                option.value = dateStr; option.textContent = formatDateKorean(date);
                select.appendChild(option);
            }
            document.getElementById('pasteDate').value = today.toISOString().split('T')[0];
        }

        function formatDateKorean(date) {
            const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
            return date.getFullYear() + 'ë…„ ' + (date.getMonth()+1) + 'ì›” ' + date.getDate() + 'ì¼ (' + days[date.getDay()] + ')';
        }

        async function loadBriefingFromDB(dateStr) {
            if (!dateStr) dateStr = new Date().toISOString().split('T')[0];
            document.getElementById('briefingDateDisplay').textContent = formatDateKorean(new Date(dateStr));
            setSyncStatus('syncing');
            try {
                const { data } = await db.from('briefings').select('*').eq('date', dateStr).single();
                if (data) { briefings[dateStr] = data; }
                renderBriefing(dateStr);
            } catch (e) { renderBriefing(dateStr); }
            setSyncStatus('synced');
        }

        function loadBriefing(dateStr) { loadBriefingFromDB(dateStr); }

        function renderBriefing(dateStr) {
            if (!dateStr) dateStr = new Date().toISOString().split('T')[0];
            const data = briefings[dateStr], container = document.getElementById('briefingContent');
            if (!data || !data.raw_content) {
                container.innerHTML = '<div class="no-briefing"><div class="icon">ğŸ“­</div><h3>ë“±ë¡ëœ ë¸Œë¦¬í•‘ì´ ì—†ìŠµë‹ˆë‹¤</h3><p>ì´ ë‚ ì§œì— ë¸Œë¦¬í•‘ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</p><button class="btn btn-primary" onclick="openPasteModal()">ğŸ“‹ ë¶™ì—¬ë„£ê¸°ë¡œ ì¶”ê°€</button></div>';
                return;
            }
            let html = data.raw_content
                .replace(/^### (.+)$/gm, '<h3 style="margin:20px 0 12px;color:var(--primary)">$1</h3>')
                .replace(/^## (.+)$/gm, '<h2 style="margin:24px 0 16px;color:var(--primary)">$1</h2>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/^- (.+)$/gm, '<li style="margin-left:20px;margin-bottom:4px">$1</li>')
                .replace(/\n/g, '<br>');
            container.innerHTML = '<div class="analysis-card" style="background:#fff;padding:24px;line-height:1.8">' + html + '</div>';
        }

        function openPasteModal() { document.getElementById('pasteContent').value = ''; document.getElementById('pasteDate').value = new Date().toISOString().split('T')[0]; openModal('pasteModal'); }

        async function savePastedBriefing() {
            const dateStr = document.getElementById('pasteDate').value, content = document.getElementById('pasteContent').value;
            if (!dateStr || !content.trim()) { alert('ë‚ ì§œì™€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            setSyncStatus('syncing');
            try {
                await db.from('briefings').upsert({ date: dateStr, raw_content: content, updated_at: new Date().toISOString() }, { onConflict: 'date' });
                briefings[dateStr] = { date: dateStr, raw_content: content };
                closeModal('pasteModal');
                document.getElementById('briefingDateSelect').value = dateStr;
                loadBriefing(dateStr);
                alert('ë¸Œë¦¬í•‘ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (e) { alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
            setSyncStatus('synced');
        }

        // í˜„ì¥ ê´€ë¦¬
        function renderAllSites() {
            const tbody = document.getElementById('allSitesTable');
            const searchTerm = document.getElementById('searchAll').value.toLowerCase();
            let filtered = sites.filter(s => {
                const matchSearch = s.site_name.toLowerCase().includes(searchTerm) || s.company_name.toLowerCase().includes(searchTerm);
                const matchFilter = currentFilter === 'all' || s.status === currentFilter;
                return matchSearch && matchFilter;
            });
            const order = { active: 0, pending: 1, completed: 2 };
            filtered.sort((a, b) => order[a.status || 'active'] - order[b.status || 'active']);
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10"><div class="empty-state"><div class="icon">ğŸ“‹</div><h3>ë“±ë¡ëœ í˜„ì¥ì´ ì—†ìŠµë‹ˆë‹¤</h3></div></td></tr>';
                return;
            }
            tbody.innerHTML = filtered.map((s, i) => {
                const statusClass = s.status === 'completed' ? 'badge-completed' : s.status === 'pending' ? 'badge-pending' : 'badge-active';
                const statusText = s.status === 'completed' ? 'ì™„ë£Œ' : s.status === 'pending' ? 'ëŒ€ê¸°ì¤‘' : 'ì§„í–‰ì¤‘';
                const typeText = s.company_type === 'concrete' ? 'ì² ê·¼ì½˜í¬ë¦¬íŠ¸' : 'ì„ê³µì‚¬';
                return '<tr><td>'+(i+1)+'</td><td class="company-name">'+s.site_name+'</td><td>'+s.company_name+'</td><td>'+typeText+'</td><td>'+(s.manager||'-')+'</td><td>'+(s.phone||'-')+'</td><td class="amount">'+(s.amount||'-')+'</td><td><div class="progress-bar"><div class="progress-fill" style="width:'+(s.progress||0)+'%"></div></div><div class="progress-text">'+(s.progress||0)+'%</div></td><td><span class="badge '+statusClass+'">'+statusText+'</span></td><td><button class="btn btn-secondary btn-sm" onclick="editSiteById(\''+s.id+'\')">ìˆ˜ì •</button> <button class="btn btn-danger btn-sm" onclick="deleteSiteById(\''+s.id+'\')">ì‚­ì œ</button></td></tr>';
            }).join('');
        }

        function searchSites() { renderAllSites(); }
        function setFilter(btn, filter) { document.querySelectorAll('#panel-all .filter-pill').forEach(p => p.classList.remove('active')); btn.classList.add('active'); currentFilter = filter; renderAllSites(); }
        function filterByStatus(status) { currentFilter = status; switchTab('all', document.querySelectorAll('.tab-btn')[1]); renderAllSites(); }
        function updateCounts() {
            document.getElementById('totalCount').textContent = sites.length;
            document.getElementById('activeCount').textContent = sites.filter(s => s.status === 'active' || !s.status).length;
            document.getElementById('pendingCount').textContent = sites.filter(s => s.status === 'pending').length;
            document.getElementById('completedCount').textContent = sites.filter(s => s.status === 'completed').length;
        }

        // ì—…ì²´ í…Œì´ë¸”
        function renderConcreteTable() {
            const container = document.getElementById('concreteTableContainer');
            const search = document.getElementById('searchConcrete').value.toLowerCase();
            let filtered = concreteCompanies.filter(c => {
                const matchSearch = c.name.toLowerCase().includes(search) || (c.ceo && c.ceo.toLowerCase().includes(search));
                const matchFilter = concreteFilter === 'all' || c.status === 'ê±°ë˜ì¤‘';
                return matchSearch && matchFilter;
            });
            if (filtered.length === 0) { container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ¢</div><h3>ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</h3></div>'; return; }
            const isAdmin = currentUser && currentUser.role === 'admin';
            const actionHeader = isAdmin ? '<th>ê´€ë¦¬</th>' : '';
            let html = '<table><thead><tr><th>ìˆœìœ„</th><th>ì—…ì²´ëª…</th><th>ëŒ€í‘œì</th><th>ì†Œì¬ì§€</th><th>ì‹œê³µëŠ¥ë ¥í‰ê°€</th><th>ìƒíƒœ</th><th>í˜„ì¥</th>'+actionHeader+'</tr></thead><tbody>';
            filtered.forEach(c => {
                const siteCount = sites.filter(s => s.company_type === 'concrete' && s.company_name === c.name).length;
                const actionCell = isAdmin ? '<td><button class="btn btn-secondary btn-xs" onclick="openEditCompanyModal(\''+c.id+'\')">ìˆ˜ì •</button></td>' : '';
                html += '<tr><td>'+(c.rank||'-')+'</td><td class="company-name">'+c.name+'</td><td>'+(c.ceo||'-')+'</td><td>'+(c.location||'-')+'</td><td class="amount">'+(c.amount||'-')+'</td><td><select onchange="updateCompanyStatusDB(\''+c.id+'\',this.value)" style="padding:6px;border-radius:4px;border:1px solid var(--border)"><option value="-"'+(c.status==='-'||!c.status?' selected':'')+'>-</option><option value="ê±°ë˜ì¤‘"'+(c.status==='ê±°ë˜ì¤‘'?' selected':'')+'>ê±°ë˜ì¤‘</option><option value="ê²¬ì ì„œì œì¶œ"'+(c.status==='ê²¬ì ì„œì œì¶œ'?' selected':'')+'>ê²¬ì ì„œì œì¶œ</option></select></td><td><button class="btn btn-secondary btn-sm" onclick="openCompanyModal(\'concrete\',\''+c.name+'\')">'+(siteCount>0?siteCount+'ê°œ í˜„ì¥':'í˜„ì¥ ì¶”ê°€')+'</button></td>'+actionCell+'</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderStoneTable() {
            const container = document.getElementById('stoneTableContainer');
            const search = document.getElementById('searchStone').value.toLowerCase();
            let filtered = stoneCompanies.filter(c => {
                const matchSearch = c.name.toLowerCase().includes(search) || (c.ceo && c.ceo.toLowerCase().includes(search));
                const matchFilter = stoneFilter === 'all' || c.status === 'ê±°ë˜ì¤‘';
                return matchSearch && matchFilter;
            });
            if (filtered.length === 0) { container.innerHTML = '<div class="empty-state"><div class="icon">ğŸª¨</div><h3>ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</h3></div>'; return; }
            const isAdmin = currentUser && currentUser.role === 'admin';
            const actionHeader = isAdmin ? '<th>ê´€ë¦¬</th>' : '';
            let html = '<table><thead><tr><th>ìˆœìœ„</th><th>ì—…ì²´ëª…</th><th>ëŒ€í‘œì</th><th>ì†Œì¬ì§€</th><th>ì‹œê³µëŠ¥ë ¥í‰ê°€</th><th>ìƒíƒœ</th><th>í˜„ì¥</th>'+actionHeader+'</tr></thead><tbody>';
            filtered.forEach(c => {
                const siteCount = sites.filter(s => s.company_type === 'stone' && s.company_name === c.name).length;
                const actionCell = isAdmin ? '<td><button class="btn btn-secondary btn-xs" onclick="openEditCompanyModal(\''+c.id+'\')">ìˆ˜ì •</button></td>' : '';
                html += '<tr><td>'+(c.rank||'-')+'</td><td class="company-name">'+c.name+'</td><td>'+(c.ceo||'-')+'</td><td>'+(c.location||'-')+'</td><td class="amount">'+(c.amount||'-')+'</td><td><select onchange="updateCompanyStatusDB(\''+c.id+'\',this.value)" style="padding:6px;border-radius:4px;border:1px solid var(--border)"><option value="-"'+(c.status==='-'||!c.status?' selected':'')+'>-</option><option value="ê±°ë˜ì¤‘"'+(c.status==='ê±°ë˜ì¤‘'?' selected':'')+'>ê±°ë˜ì¤‘</option><option value="ê²¬ì ì„œì œì¶œ"'+(c.status==='ê²¬ì ì„œì œì¶œ'?' selected':'')+'>ê²¬ì ì„œì œì¶œ</option></select></td><td><button class="btn btn-secondary btn-sm" onclick="openCompanyModal(\'stone\',\''+c.name+'\')">'+(siteCount>0?siteCount+'ê°œ í˜„ì¥':'í˜„ì¥ ì¶”ê°€')+'</button></td>'+actionCell+'</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function setConcreteFilter(btn, filter) { document.querySelectorAll('#panel-concrete .filter-pill').forEach(p => p.classList.remove('active')); btn.classList.add('active'); concreteFilter = filter; renderConcreteTable(); }
        function setStoneFilter(btn, filter) { document.querySelectorAll('#panel-stone .filter-pill').forEach(p => p.classList.remove('active')); btn.classList.add('active'); stoneFilter = filter; renderStoneTable(); }

        async function updateCompanyStatusDB(companyId, status) {
            setSyncStatus('syncing');
            try {
                await db.from('companies').update({ status: status, updated_at: new Date().toISOString() }).eq('id', companyId);
                const cc = concreteCompanies.find(c => c.id === companyId);
                const sc = stoneCompanies.find(c => c.id === companyId);
                if (cc) cc.status = status;
                if (sc) sc.status = status;
            } catch (e) { alert('ìƒíƒœ ì €ì¥ ì˜¤ë¥˜'); }
            setSyncStatus('synced');
        }

        // ì—…ì²´ ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ (ê´€ë¦¬ì)
        function openAddCompanyModal(type) {
            document.getElementById('companyEditModalTitle').textContent = type === 'concrete' ? 'ì² ê·¼ì½˜í¬ë¦¬íŠ¸ ì—…ì²´ ì¶”ê°€' : 'ì„ê³µì‚¬ ì—…ì²´ ì¶”ê°€';
            document.getElementById('companyEditId').value = '';
            document.getElementById('companyEditType').value = type;
            document.getElementById('companyRank').value = '';
            document.getElementById('companyNameEdit').value = '';
            document.getElementById('companyCeo').value = '';
            document.getElementById('companyLocation').value = '';
            document.getElementById('companyAmount').value = '';
            document.getElementById('companyStatusEdit').value = '-';
            document.getElementById('companyDeleteBtn').style.display = 'none';
            openModal('companyEditModal');
        }

        function openEditCompanyModal(companyId) {
            let company = concreteCompanies.find(c => c.id === companyId) || stoneCompanies.find(c => c.id === companyId);
            if (!company) { alert('ì—…ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
            document.getElementById('companyEditModalTitle').textContent = 'ì—…ì²´ ì •ë³´ ìˆ˜ì •';
            document.getElementById('companyEditId').value = company.id;
            document.getElementById('companyEditType').value = company.company_type;
            document.getElementById('companyRank').value = company.rank || '';
            document.getElementById('companyNameEdit').value = company.name || '';
            document.getElementById('companyCeo').value = company.ceo || '';
            document.getElementById('companyLocation').value = company.location || '';
            document.getElementById('companyAmount').value = company.amount || '';
            document.getElementById('companyStatusEdit').value = company.status || '-';
            document.getElementById('companyDeleteBtn').style.display = 'block';
            openModal('companyEditModal');
        }

        async function saveCompany() {
            const id = document.getElementById('companyEditId').value;
            const type = document.getElementById('companyEditType').value;
            const name = document.getElementById('companyNameEdit').value.trim();
            if (!name) { alert('ì—…ì²´ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            const data = {
                company_type: type,
                rank: parseInt(document.getElementById('companyRank').value) || null,
                name: name,
                ceo: document.getElementById('companyCeo').value.trim() || '-',
                location: document.getElementById('companyLocation').value.trim(),
                amount: document.getElementById('companyAmount').value.trim(),
                status: document.getElementById('companyStatusEdit').value,
                updated_at: new Date().toISOString()
            };
            setSyncStatus('syncing');
            try {
                if (id) { await db.from('companies').update(data).eq('id', id); }
                else { await db.from('companies').insert([data]); }
                closeModal('companyEditModal');
                await loadCompaniesFromDB();
                renderAll();
                alert(id ? 'ì—…ì²´ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì—…ì²´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (e) { alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
            setSyncStatus('synced');
        }

        async function deleteCompany() {
            const id = document.getElementById('companyEditId').value;
            const name = document.getElementById('companyNameEdit').value;
            if (!confirm('"' + name + '" ì—…ì²´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            setSyncStatus('syncing');
            try {
                await db.from('companies').delete().eq('id', id);
                closeModal('companyEditModal');
                await loadCompaniesFromDB();
                renderAll();
                alert('ì—…ì²´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (e) { alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
            setSyncStatus('synced');
        }

        // ëª¨ë‹¬ ë° í˜„ì¥ ê´€ë¦¬
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function openCompanyModal(type, name) {
            editingCompanyType = type; editingCompanyName = name;
            document.getElementById('companyModalTitle').textContent = name + ' í˜„ì¥ ê´€ë¦¬';
            renderCompanySites();
            openModal('companyModal');
        }

        function renderCompanySites() {
            const list = sites.filter(s => s.company_type === editingCompanyType && s.company_name === editingCompanyName);
            const container = document.getElementById('companySiteList');
            if (list.length === 0) { container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“‹</div><h3>ë“±ë¡ëœ í˜„ì¥ ì—†ìŒ</h3></div>'; return; }
            container.innerHTML = list.map(s => {
                const statusText = s.status === 'completed' ? 'ì™„ë£Œ' : s.status === 'pending' ? 'ëŒ€ê¸°ì¤‘' : 'ì§„í–‰ì¤‘';
                return '<div class="site-item"><div class="site-info"><h4>'+s.site_name+'</h4><p>'+(s.address||'ì£¼ì†Œ ë¯¸ë“±ë¡')+' | '+statusText+' | ì§„í–‰ë¥  '+(s.progress||0)+'%</p></div><div class="site-actions"><button class="btn btn-secondary btn-sm" onclick="editSiteById(\''+s.id+'\')">ìˆ˜ì •</button><button class="btn btn-danger btn-sm" onclick="deleteSiteById(\''+s.id+'\')">ì‚­ì œ</button></div></div>';
            }).join('');
        }

        function addSiteToCompany() { editingSiteId = null; clearSiteForm(); document.getElementById('siteModalTitle').textContent = 'ìƒˆ í˜„ì¥ ì¶”ê°€'; openModal('siteModal'); }

        function editSiteById(id) {
            const site = sites.find(s => s.id === id);
            if (!site) return;
            editingSiteId = id; editingCompanyType = site.company_type; editingCompanyName = site.company_name;
            document.getElementById('siteName').value = site.site_name || '';
            document.getElementById('siteAddr').value = site.address || '';
            document.getElementById('siteManager').value = site.manager || '';
            document.getElementById('sitePhone').value = site.phone || '';
            document.getElementById('siteAmount').value = site.amount || '';
            document.getElementById('siteProgress').value = site.progress || 0;
            document.getElementById('siteStatus').value = site.status || 'active';
            document.getElementById('siteModalTitle').textContent = 'í˜„ì¥ ì •ë³´ ìˆ˜ì •';
            openModal('siteModal');
        }

        function clearSiteForm() {
            ['siteName','siteAddr','siteManager','sitePhone','siteAmount'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('siteProgress').value = 0;
            document.getElementById('siteStatus').value = 'active';
        }

        async function saveSite() {
            const name = document.getElementById('siteName').value.trim();
            if (!name) { alert('í˜„ì¥ëª…ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
            const data = {
                company_type: editingCompanyType, company_name: editingCompanyName, site_name: name,
                address: document.getElementById('siteAddr').value.trim(),
                manager: document.getElementById('siteManager').value.trim(),
                phone: document.getElementById('sitePhone').value.trim(),
                amount: document.getElementById('siteAmount').value.trim(),
                progress: parseInt(document.getElementById('siteProgress').value) || 0,
                status: document.getElementById('siteStatus').value,
                updated_at: new Date().toISOString()
            };
            setSyncStatus('syncing');
            try {
                if (editingSiteId) { await db.from('sites').update(data).eq('id', editingSiteId); }
                else { await db.from('sites').insert([data]); }
                await loadAllData(); closeModal('siteModal'); renderCompanySites(); renderAll();
            } catch (e) { alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
            setSyncStatus('synced');
        }

        async function deleteSiteById(id) {
            if (!confirm('ì´ í˜„ì¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            setSyncStatus('syncing');
            try { await db.from('sites').delete().eq('id', id); await loadAllData(); renderCompanySites(); renderAll(); }
            catch (e) { console.error('ì‚­ì œ ì˜¤ë¥˜:', e); }
            setSyncStatus('synced');
        }

        // ë¹ ë¥¸ í˜„ì¥ ì¶”ê°€
        function openQuickAddModal() {
            document.getElementById('quickType').value = '';
            document.getElementById('quickCompany').innerHTML = '<option value="">ë¨¼ì € ê³µì‚¬ êµ¬ë¶„ì„ ì„ íƒí•˜ì„¸ìš”</option>';
            ['quickSiteName','quickAddr','quickManager','quickPhone'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('quickStatus').value = 'active';
            openModal('quickAddModal');
        }

        function updateQuickCompanyList() {
            const type = document.getElementById('quickType').value;
            const select = document.getElementById('quickCompany');
            if (!type) { select.innerHTML = '<option value="">ë¨¼ì € ê³µì‚¬ êµ¬ë¶„ì„ ì„ íƒí•˜ì„¸ìš”</option>'; return; }
            const list = type === 'concrete' ? concreteCompanies : stoneCompanies;
            let html = '<option value="">ì—…ì²´ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            list.filter(c => c.status === 'ê±°ë˜ì¤‘').forEach(c => { html += '<option value="'+c.name+'">'+c.name+' (ê±°ë˜ì¤‘)</option>'; });
            list.filter(c => c.status !== 'ê±°ë˜ì¤‘').forEach(c => { html += '<option value="'+c.name+'">'+c.name+'</option>'; });
            select.innerHTML = html;
        }

        async function saveQuickSite() {
            const type = document.getElementById('quickType').value;
            const company = document.getElementById('quickCompany').value;
            const name = document.getElementById('quickSiteName').value.trim();
            if (!type || !company || !name) { alert('ê³µì‚¬ êµ¬ë¶„, ì—…ì²´, í˜„ì¥ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
            editingCompanyType = type; editingCompanyName = company; editingSiteId = null;
            const data = {
                company_type: type, company_name: company, site_name: name,
                address: document.getElementById('quickAddr').value.trim(),
                manager: document.getElementById('quickManager').value.trim(),
                phone: document.getElementById('quickPhone').value.trim(),
                amount: '', progress: 0, status: document.getElementById('quickStatus').value
            };
            setSyncStatus('syncing');
            try { await db.from('sites').insert([data]); await loadAllData(); closeModal('quickAddModal'); renderAll(); alert('í˜„ì¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!'); }
            catch (e) { alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
            setSyncStatus('synced');
        }

        // íšŒì› ê´€ë¦¬
        function openUserModal() { renderUserList(); openModal('userModal'); }
        function renderUserList() {
            const container = document.getElementById('userList');
            container.innerHTML = users.map(u => {
                const roleClass = u.role === 'admin' ? 'badge-trading' : 'badge-active';
                const roleText = u.role === 'admin' ? 'ê´€ë¦¬ì' : 'ì‚¬ìš©ì';
                return '<div class="site-item"><div class="site-info"><h4>'+u.name+' <span class="badge '+roleClass+'">'+roleText+'</span></h4><p>ID: '+u.user_id+' | ë¶€ì„œ: '+(u.department||'ë¯¸ì§€ì •')+'</p></div><div class="site-actions">'+(u.user_id !== 'baekop99' ? '<button class="btn btn-secondary btn-sm" onclick="toggleRoleDB(\''+u.id+'\',\''+u.role+'\')">'+(u.role==='admin'?'ì‚¬ìš©ìë¡œ':'ê´€ë¦¬ìë¡œ')+'</button><button class="btn btn-danger btn-sm" onclick="deleteUserDB(\''+u.id+'\')">ì‚­ì œ</button>':'')+'</div></div>';
            }).join('');
        }

        async function toggleRoleDB(id, currentRole) {
            const newRole = currentRole === 'admin' ? 'user' : 'admin';
            try { await db.from('site_users').update({ role: newRole }).eq('id', id); await loadAllData(); renderUserList(); }
            catch (e) { console.error('ì—­í•  ë³€ê²½ ì˜¤ë¥˜:', e); }
        }

        async function deleteUserDB(id) {
            if (!confirm('ì´ íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try { await db.from('site_users').delete().eq('id', id); await loadAllData(); renderUserList(); }
            catch (e) { console.error('ì‚­ì œ ì˜¤ë¥˜:', e); }
        }

        // ì˜ì—… ê³„íš ê´€ë¦¬
        function getYearFromStartDate(startDate) {
            if (!startDate) return '';
            const match = startDate.match(/(\d{2})ë…„/);
            if (match) return match[1];
            return '';
        }

        function getMonthFromStartDate(startDate) {
            if (!startDate) return '';
            const match = startDate.match(/(\d{1,2})ì›”/);
            if (match) return match[1];
            if (startDate.includes('ìƒë°˜ê¸°')) return '6';
            if (startDate.includes('í•˜ë°˜ê¸°')) return '12';
            if (startDate.includes('ì¤‘ë°˜')) return '6';
            return '';
        }

        function updateSalesCounts() {
            const yearFilter = document.getElementById('salesYearFilter').value;
            const categoryFilter = document.getElementById('salesCategoryFilter').value;
            const counts = { total: 0, '1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0 };
            salesPlans.forEach(s => {
                // ë…„ë„ í•„í„° ì ìš©
                if (yearFilter !== 'all') {
                    const year = getYearFromStartDate(s.start_date);
                    if (year !== yearFilter) return;
                }
                // ëŒ€ë¶„ë¥˜ í•„í„° ì ìš©
                if (categoryFilter !== 'all') {
                    if ((s.category || 'ê±´ì¶•') !== categoryFilter) return;
                }
                counts.total++;
                const month = getMonthFromStartDate(s.start_date);
                if (month && counts[month] !== undefined) counts[month]++;
            });
            document.getElementById('salesTotalCount').textContent = counts.total;
            for (let i = 1; i <= 12; i++) {
                const el = document.getElementById('salesMonth' + i);
                if (el) el.textContent = counts[i];
            }
        }

        function setSalesMonthFilter(month) {
            salesMonthFilter = month;
            renderSalesTable();
            // ì„ íƒëœ ì›” ì¹´ë“œ í•˜ì´ë¼ì´íŠ¸
            document.querySelectorAll('#panel-sales .stat-card').forEach(card => {
                card.style.borderColor = 'var(--border)';
            });
        }

        function renderSalesTable() {
            updateSalesCounts();
            const container = document.getElementById('salesTableContainer');
            const search = document.getElementById('searchSales').value.toLowerCase();
            const yearFilter = document.getElementById('salesYearFilter').value;
            const categoryFilter = document.getElementById('salesCategoryFilter').value;
            let filtered = salesPlans.filter(s => {
                const matchSearch = (s.site_name && s.site_name.toLowerCase().includes(search)) || 
                                   (s.region && s.region.toLowerCase().includes(search)) ||
                                   (s.construction_company && s.construction_company.toLowerCase().includes(search)) ||
                                   (s.concrete_company && s.concrete_company.toLowerCase().includes(search));
                let matchFilter = true;
                if (salesFilter === 'mine') matchFilter = s.assigned_user === currentUser.name;
                if (salesFilter === 'unassigned') matchFilter = !s.assigned_user;
                // ë…„ë„ í•„í„°
                let matchYear = true;
                if (yearFilter !== 'all') {
                    const year = getYearFromStartDate(s.start_date);
                    matchYear = year === yearFilter;
                }
                // ëŒ€ë¶„ë¥˜ í•„í„°
                let matchCategory = true;
                if (categoryFilter !== 'all') {
                    matchCategory = (s.category || 'ê±´ì¶•') === categoryFilter;
                }
                // ì›”ë³„ í•„í„°
                let matchMonth = true;
                if (salesMonthFilter !== 'all') {
                    const month = getMonthFromStartDate(s.start_date);
                    matchMonth = month === salesMonthFilter;
                }
                return matchSearch && matchFilter && matchYear && matchCategory && matchMonth;
            });
            if (filtered.length === 0) { 
                container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“ˆ</div><h3>ì˜ì—… ê³„íš ì—†ìŒ</h3><p>í•´ë‹¹ ì¡°ê±´ì˜ ì˜ì—… ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.</p></div>'; 
                return; 
            }
            let html = '<table><thead><tr><th>ëŒ€ë¶„ë¥˜</th><th>ì§€ì—­</th><th>í˜„ì¥ëª…</th><th>êµ¬ë¶„</th><th>ê³¨ì¡°ì‚¬</th><th>ê±´ì„¤ì‚¬</th><th>ê·œëª¨</th><th>ì°©ê³µì¼</th><th>ë¹„ê³ </th><th>ì˜ì—… ë‹´ë‹¹</th><th>ê´€ë¦¬</th></tr></thead><tbody>';
            filtered.forEach(s => {
                const isAssigned = s.assigned_user;
                const assignBtn = isAssigned 
                    ? '<span class="badge badge-trading">'+s.assigned_user+'</span>' + (s.assigned_user === currentUser.name || currentUser.role === 'admin' ? ' <button class="btn btn-danger btn-xs" onclick="unassignSalesPlan(\''+s.id+'\')">ì·¨ì†Œ</button>' : '')
                    : '<button class="btn btn-success btn-xs" onclick="assignSalesPlan(\''+s.id+'\')">ë‚´ê°€ ê°ˆê²Œìš”</button>';
                const categoryBadge = (s.category || 'ê±´ì¶•') === 'ì„ì¬' ? '<span class="badge badge-completed">ğŸª¨ ì„ì¬</span>' : '<span class="badge badge-active">ğŸ—ï¸ ê±´ì¶•</span>';
                html += '<tr><td>'+categoryBadge+'</td><td>'+(s.region||'-')+'</td><td class="company-name">'+(s.site_name||'-')+'</td><td>'+(s.section||'-')+'</td><td>'+(s.concrete_company||'-')+'</td><td>'+(s.construction_company||'-')+'</td><td>'+(s.scale||'-')+'</td><td>'+(s.start_date||'-')+'</td><td style="max-width:150px;font-size:12px;color:var(--text-light)">'+(s.memo||'-')+'</td><td>'+assignBtn+'</td><td><button class="btn btn-secondary btn-xs" onclick="openEditSalesPlan(\''+s.id+'\')">ìˆ˜ì •</button></td></tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function setSalesFilter(btn, filter) {
            document.querySelectorAll('#panel-sales .filter-pill').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            salesFilter = filter;
            renderSalesTable();
        }

        async function assignSalesPlan(id) {
            setSyncStatus('syncing');
            try {
                await db.from('sales_plan').update({ 
                    assigned_user: currentUser.name, 
                    assigned_at: new Date().toISOString() 
                }).eq('id', id);
                const plan = salesPlans.find(s => s.id === id);
                if (plan) { plan.assigned_user = currentUser.name; plan.assigned_at = new Date().toISOString(); }
                renderSalesTable();
            } catch (e) { alert('ë‹´ë‹¹ ì§€ì • ì˜¤ë¥˜'); }
            setSyncStatus('synced');
        }

        async function unassignSalesPlan(id) {
            if (!confirm('ë‹´ë‹¹ ì§€ì •ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            setSyncStatus('syncing');
            try {
                await db.from('sales_plan').update({ assigned_user: null, assigned_at: null }).eq('id', id);
                const plan = salesPlans.find(s => s.id === id);
                if (plan) { plan.assigned_user = null; plan.assigned_at = null; }
                renderSalesTable();
            } catch (e) { alert('ì·¨ì†Œ ì˜¤ë¥˜'); }
            setSyncStatus('synced');
        }

        function openSalesPlanModal() {
            document.getElementById('salesPlanModalTitle').textContent = 'ì˜ì—… ê³„íš ì¶”ê°€';
            document.getElementById('salesPlanId').value = '';
            document.getElementById('salesCategory').value = 'ê±´ì¶•';
            ['salesRegion','salesSection','salesSiteName','salesConcrete','salesConstruction','salesScale','salesStartDate','salesMemo'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('salesDeleteBtn').style.display = 'none';
            openModal('salesPlanModal');
        }

        function openEditSalesPlan(id) {
            const plan = salesPlans.find(s => s.id === id);
            if (!plan) return;
            document.getElementById('salesPlanModalTitle').textContent = 'ì˜ì—… ê³„íš ìˆ˜ì •';
            document.getElementById('salesPlanId').value = plan.id;
            document.getElementById('salesCategory').value = plan.category || 'ê±´ì¶•';
            document.getElementById('salesRegion').value = plan.region || '';
            document.getElementById('salesSection').value = plan.section || '';
            document.getElementById('salesSiteName').value = plan.site_name || '';
            document.getElementById('salesConcrete').value = plan.concrete_company || '';
            document.getElementById('salesConstruction').value = plan.construction_company || '';
            document.getElementById('salesScale').value = plan.scale || '';
            document.getElementById('salesStartDate').value = plan.start_date || '';
            document.getElementById('salesMemo').value = plan.memo || '';
            document.getElementById('salesDeleteBtn').style.display = 'block';
            openModal('salesPlanModal');
        }

        async function saveSalesPlan() {
            const siteName = document.getElementById('salesSiteName').value.trim();
            if (!siteName) { alert('í˜„ì¥ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            const id = document.getElementById('salesPlanId').value;
            const data = {
                category: document.getElementById('salesCategory').value,
                region: document.getElementById('salesRegion').value.trim(),
                site_name: siteName,
                section: document.getElementById('salesSection').value.trim(),
                concrete_company: document.getElementById('salesConcrete').value.trim(),
                construction_company: document.getElementById('salesConstruction').value.trim(),
                scale: document.getElementById('salesScale').value.trim(),
                start_date: document.getElementById('salesStartDate').value.trim(),
                memo: document.getElementById('salesMemo').value.trim(),
                updated_at: new Date().toISOString()
            };
            setSyncStatus('syncing');
            try {
                if (id) { await db.from('sales_plan').update(data).eq('id', id); }
                else { await db.from('sales_plan').insert([data]); }
                closeModal('salesPlanModal');
                await loadAllData();
                renderSalesTable();
                alert(id ? 'ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (e) { alert('ì €ì¥ ì˜¤ë¥˜'); }
            setSyncStatus('synced');
        }

        async function deleteSalesPlan() {
            const id = document.getElementById('salesPlanId').value;
            if (!confirm('ì´ ì˜ì—… ê³„íšì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            setSyncStatus('syncing');
            try {
                await db.from('sales_plan').delete().eq('id', id);
                closeModal('salesPlanModal');
                await loadAllData();
                renderSalesTable();
                alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (e) { alert('ì‚­ì œ ì˜¤ë¥˜'); }
            setSyncStatus('synced');
        }

        // ì—‘ì…€ ì—…ë¡œë“œ ê´€ë ¨
        let excelWorkbook = null;
        let excelParsedData = [];

        function openExcelUploadModal() {
            document.getElementById('excelFileInput').value = '';
            document.getElementById('sheetSelectGroup').style.display = 'none';
            document.getElementById('excelPreview').style.display = 'none';
            document.getElementById('excelImportBtn').disabled = true;
            excelWorkbook = null;
            excelParsedData = [];
            openModal('excelUploadModal');
        }

        function handleExcelFile(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    excelWorkbook = XLSX.read(e.target.result, { type: 'binary' });
                    const sheetSelect = document.getElementById('sheetSelect');
                    sheetSelect.innerHTML = excelWorkbook.SheetNames.map(name => 
                        '<option value="' + name + '">' + name + '</option>'
                    ).join('');
                    document.getElementById('sheetSelectGroup').style.display = 'block';
                    parseSelectedSheet();
                } catch (err) {
                    alert('ì—‘ì…€ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + err.message);
                }
            };
            reader.readAsBinaryString(file);
        }

        function parseSelectedSheet() {
            if (!excelWorkbook) return;
            const sheetName = document.getElementById('sheetSelect').value;
            const sheet = excelWorkbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
            
            // í—¤ë” ì°¾ê¸° (ì§€ì—­, í˜„ì¥ëª… ë“±ì´ ìˆëŠ” í–‰)
            let headerRow = -1;
            let colMap = {};
            for (let i = 0; i < Math.min(jsonData.length, 15); i++) {
                const row = jsonData[i];
                for (let j = 0; j < row.length; j++) {
                    const cell = String(row[j]).trim().toLowerCase();
                    if (cell.includes('ì§€ì—­')) colMap.region = j;
                    if (cell.includes('í˜„ì¥') && !cell.includes('í˜„ì¥ìˆ˜')) colMap.site_name = j;
                    if (cell.includes('ì‚¬ì—…') || cell.includes('êµ¬ë¶„')) colMap.section = j;
                    if (cell.includes('ì² ì½˜') || cell.includes('ê³¨ì¡°')) colMap.concrete = j;
                    if (cell.includes('ê±´ì„¤ì‚¬')) colMap.construction = j;
                    if (cell === 'ì¸µ' || cell.includes('ê·œëª¨')) colMap.scale_start = j;
                    if (cell.includes('ì°©ê³µ')) colMap.start_date = j;
                    if (cell.includes('ë¹„ê³ ') || cell.includes('ë©”ëª¨')) colMap.memo = j;
                }
                if (colMap.site_name !== undefined) {
                    headerRow = i;
                    break;
                }
            }
            
            if (headerRow === -1) {
                alert('í˜„ì¥ëª… ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ê·œëª¨ ì»¬ëŸ¼ ì°¾ê¸° (ì¸µ ì»¬ëŸ¼ì´ 2ê°œì¼ ìˆ˜ ìˆìŒ: ì§€í•˜/ì§€ìƒ)
            const headerRowData = jsonData[headerRow];
            let scaleColB = -1, scaleColF = -1;
            for (let j = 0; j < headerRowData.length; j++) {
                const cell = String(headerRowData[j]).trim();
                if (cell === 'ì¸µ') {
                    if (scaleColB === -1) scaleColB = j;
                    else scaleColF = j;
                }
            }
            
            // ì°©ê³µë…„/ì›” ì»¬ëŸ¼ ì°¾ê¸°
            let startYearCol = -1, startMonthCol = -1;
            for (let j = 0; j < headerRowData.length; j++) {
                const cell = String(headerRowData[j]).trim();
                if (cell === 'ì°©ê³µì¼' || cell === 'ë…„') {
                    if (startYearCol === -1) startYearCol = j;
                }
                if (cell === 'ì›”') startMonthCol = j;
            }
            if (startYearCol === -1 && colMap.start_date !== undefined) startYearCol = colMap.start_date;

            // ë°ì´í„° íŒŒì‹±
            excelParsedData = [];
            for (let i = headerRow + 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                const siteName = String(row[colMap.site_name] || '').trim();
                if (!siteName) continue;
                
                // ê·œëª¨ í•©ì¹˜ê¸°
                let scale = '';
                if (scaleColB !== -1 && row[scaleColB]) {
                    const b = String(row[scaleColB]).replace(/[^0-9]/g, '');
                    if (b) scale += 'B' + b;
                }
                if (scaleColF !== -1 && row[scaleColF]) {
                    const f = String(row[scaleColF]).replace(/[^0-9]/g, '');
                    if (f) scale += (scale ? '/' : '') + f + 'F';
                }
                
                // ì°©ê³µì¼ í•©ì¹˜ê¸°
                let startDate = '';
                if (startYearCol !== -1 && row[startYearCol]) {
                    let y = String(row[startYearCol]).replace('ë…„', '').trim();
                    startDate = y + 'ë…„';
                }
                if (startMonthCol !== -1 && row[startMonthCol]) {
                    let m = String(row[startMonthCol]).replace('ì›”', '').trim();
                    startDate += ' ' + m + 'ì›”';
                }
                
                excelParsedData.push({
                    region: String(row[colMap.region] || '').trim(),
                    site_name: siteName,
                    section: String(row[colMap.section] || '').trim(),
                    concrete_company: String(row[colMap.concrete] || '').trim(),
                    construction_company: String(row[colMap.construction] || '').trim(),
                    scale: scale.trim(),
                    start_date: startDate.trim(),
                    memo: String(row[colMap.memo] || '').trim()
                });
            }
            
            // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
            renderExcelPreview();
        }

        function renderExcelPreview() {
            if (excelParsedData.length === 0) {
                document.getElementById('excelPreview').style.display = 'none';
                document.getElementById('excelImportBtn').disabled = true;
                return;
            }
            
            document.getElementById('previewCount').textContent = excelParsedData.length;
            const thead = document.querySelector('#excelPreviewTable thead');
            const tbody = document.querySelector('#excelPreviewTable tbody');
            
            thead.innerHTML = '<tr><th>ì§€ì—­</th><th>í˜„ì¥ëª…</th><th>êµ¬ë¶„</th><th>ê³¨ì¡°ì‚¬</th><th>ê±´ì„¤ì‚¬</th><th>ê·œëª¨</th><th>ì°©ê³µì¼</th><th>ë¹„ê³ </th></tr>';
            tbody.innerHTML = excelParsedData.slice(0, 50).map(d => 
                '<tr><td>'+(d.region||'-')+'</td><td>'+(d.site_name||'-')+'</td><td>'+(d.section||'-')+'</td><td>'+(d.concrete_company||'-')+'</td><td>'+(d.construction_company||'-')+'</td><td>'+(d.scale||'-')+'</td><td>'+(d.start_date||'-')+'</td><td>'+(d.memo||'-')+'</td></tr>'
            ).join('');
            
            document.getElementById('excelPreview').style.display = 'block';
            document.getElementById('excelImportBtn').disabled = false;
        }

        async function importExcelData() {
            if (excelParsedData.length === 0) {
                alert('ì¶”ê°€í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            if (!confirm(excelParsedData.length + 'ê°œ í˜„ì¥ì„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            setSyncStatus('syncing');
            try {
                await db.from('sales_plan').insert(excelParsedData);
                closeModal('excelUploadModal');
                await loadAllData();
                renderSalesTable();
                alert(excelParsedData.length + 'ê°œ í˜„ì¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (e) {
                alert('ì¶”ê°€ ì˜¤ë¥˜: ' + e.message);
            }
            setSyncStatus('synced');
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', e => { if (e.target === overlay) overlay.style.display = 'none'; });
        });
    </script>
</body>
</html>
